<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <!-- 引入AntvX6 图形渲染引擎 -->
    <script src="https://unpkg.com/@antv/x6@1.31.0/dist/x6.js"></script>
    <!-- 引入 Vue -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <!-- 引入 layui -->
    <link
      href="https://unpkg.com/layui@2.7.6/dist/css/layui.css"
      rel="stylesheet"
    />
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/layui/2.7.6/layui.js"
      integrity="sha512-mIKH3M2bRlIyhG4tBEbJ8dn8t8JFlNJU2NXlJePgpQ72CK4jAYsZyCGFcASRGtPBbcAQhz67KTkA1Jw6Kizk9g=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    ></script>
    <title>Document</title>
  </head>
  <body>
    <div id="app">
      <div class="layui-row">
        <div class="layui-col-md1">
          <div data-type="circle" class="dnd-wrap dnd-circle">开始</div>
          <div data-type="rect" class="dnd-wrap dnd-rect">步骤</div>
          <div data-type="polygon" class="dnd-wrap dnd-polygon">条件</div>
          <div data-type="circleEnd" class="dnd-wrap dnd-rect">结束</div>
        </div>
        <div class="layui-col-md11">
          <div class="layui-btn-group">
            <button type="button" class="layui-btn" @click="clearDraw">
              清空画布
            </button>
            <button type="button" class="layui-btn" @click="doThing('canUndo')">
              撤销
            </button>
            <button type="button" class="layui-btn" @click="doThing('canRedo')">
              重做
            </button>
            <button type="button" class="layui-btn" @click="deleteSelect">
              删除
            </button>
            <button
              type="button"
              class="layui-btn"
              @click="printNodeList('PNG')"
            >
              导出PNG
            </button>
            <button
              type="button"
              class="layui-btn"
              @click="printNodeList('SVG')"
            >
              导出SVG
            </button>
            <button type="button" class="layui-btn">检查 - 未做</button>
            <button type="button" class="layui-btn">保存 - 未做</button>
          </div>
          <div
            class="wapper"
            style="
              height: calc(100vh - calc(5rem + 1px + 40px));
              overflow: auto;
            "
          >
            <div id="container"></div>
          </div>
        </div>
      </div>
    </div>
    <script>
      var { Graph, DataUri, Addon } = X6;
      const { createApp } = Vue;

      // 创建vue节点
      createApp({
        data() {
          return {
            dataOption: {},
            graph: {},
            ports: {
              groups: {
                // 输入链接桩群组定义
                in: {
                  position: "ellipseSpread",
                  attrs: {
                    circle: {
                      r: 4,
                      magnet: true,
                      stroke: "#8d8d8d",
                      strokeWidth: 2,
                      fill: "#fdff00",
                      style: {
                        visibility: "hidden",
                      },
                    },
                  },
                },
              },
              items: [
                {
                  id: "port1",
                  group: "in",
                },
                {
                  id: "port2",
                  group: "in",
                },
                {
                  id: "port3",
                  group: "in",
                },
                {
                  id: "port4",
                  group: "in",
                },
              ],
            },
            dnd: {},
            history: {},
            canRedo: false,
            canUndo: false,
          };
        },
        methods: {
          // 导出
          printNodeList(type) {
            if (type === "PNG") {
              this.graph.toPNG(
                (dataUri) => {
                  // 下载
                  DataUri.downloadDataUri(dataUri, "chart.png");
                },
                {
                  padding: {
                    top: 20,
                    right: 30,
                    bottom: 40,
                    left: 50,
                  },
                  copyStyles: false,
                }
              );
            } else {
              this.graph.toSVG(
                (dataUri) => {
                  // 下载
                  DataUri.downloadDataUri(
                    DataUri.svgToDataUrl(dataUri),
                    "chart.svg"
                  );
                },
                {
                  copyStyles: false,
                }
              );
            }
          },
          // 添加
          startDrag(e) {
            const target = e.target;
            const type = target.attributes["data-type"].value;
            let node;
            if (type === "rect") {
              node = this.graph.createNode({
                width: 100,
                height: 40,
                ports: this.ports,
                attrs: {
                  label: {
                    text: "步骤",
                    fill: "#262626",
                  },
                  body: {
                    fill: "#c7d9fc",
                    stroke: "#5f95ff",
                    strokeWidth: "2",
                  },
                },
              });
            } else if (type === "circle") {
              node = this.graph.createNode({
                width: 60,
                height: 60,
                shape: "html",
                shape: "circle",
                ports: this.ports,
                attrs: {
                  label: {
                    text: "开始",
                    fill: "#2a7a22",
                  },
                  body: {
                    fill: "#88f299",
                    stroke: "#347527",
                    strokeWidth: "1",
                  },
                },
              });
            } else if (type === "polygon") {
              node = this.graph.createNode({
                shape: "polygon",
                width: 80,
                height: 80,
                ports: this.ports,
                attrs: {
                  label: {
                    text: "条件",
                    fill: "#6e3210",
                  },
                  body: {
                    fill: "#efdbff",
                    stroke: "#9254de",
                    refPoints: "0, 35 50, 0 100, 35 50, 70",
                    strokeWidth: "1",
                  },
                },
              });
            } else if (type === "circleEnd") {
              node = this.graph.createNode({
                width: 60,
                height: 60,
                shape: "html",
                shape: "circle",
                ports: this.ports,
                attrs: {
                  label: {
                    text: "结束",
                    fill: "#ffffff",
                  },
                  body: {
                    fill: "#fa4e48",
                    stroke: "#8f2424",
                    strokeWidth: "1",
                  },
                },
              });
            }

            this.dnd.start(node, e);
          },
          // 清空画布
          clearDraw() {
            var index = layer.open({
              title: "提示",
              content: "是否清空画布",
              btn: ["确认", "取消"],
              yes: (index, layero) => {
                this.graph.clearCells();
                layer.close(layer.index);
                layer.msg("操作成功");
              },
            });
          },
          // 撤销 和 重做
          doThing(type) {
            if (type === "canUndo") {
              this.graph.undo();
            } else if (type === "canRedo") {
              this.graph.redo();
            } else {
              console.log(type);
            }
          },
          // 连接桩显示时机
          showPorts(ports, show) {
            for (let i = 0, len = ports.length; i < len; i = i + 1) {
              ports[i].style.visibility = show ? "visible" : "hidden";
            }
          },
          // 删除
          deleteSelect() {
            this.graph.removeCells(this.graph.getSelectedCells());
          },
        },
        mounted() {
          let _this = this;
          // 初始化默认添加事件
          document.querySelectorAll(".dnd-wrap").forEach((item) => {
            item.addEventListener("mousedown", _this.startDrag);
          });
          this.graph = new Graph({
            container: document.getElementById("container"),
            history: true,
            selecting: { enabled: true },
            grid: {
              size: 10, // 网格大小 10px
              visible: true, // 渲染网格背景
            },
            mousewheel: {
              enabled: true,
              zoomAtMousePosition: true,
              modifiers: ["ctrl", "meta"],
              maxScale: 3,
              minScale: 0.3,
            },
            // 框选
            selecting: {
              enabled: true,
              multiple: true,
              rubberband: true,
              movable: true,
              showNodeSelectionBox: true,
            },
            // 开启撤销/重做
            history: {
              enabled: true,
              ignoreChange: true,
            },
            width: 6000,
            height: 6000,
          });
          this.graph.on("cell:mouseenter", ({ cell }) => {
            if (cell.isNode()) {
              cell.addTools([
                {
                  name: "button-remove",
                  local: true,
                  args: {
                    x: cell.shape === "polygon" ? 20 : 10,
                    y: cell.shape === "polygon" ? 20 : 10,
                  },
                },
              ]);
              const ports = document.querySelectorAll(
                `[data-cell-id='${cell.id}'] .x6-port-body`
              );
              this.showPorts(ports, true);
            } else {
              cell.addTools([
                {
                  local: true,
                  name: "button-remove", // 工具名称
                },
              ]);
            }
          });
          this.graph.on("cell:mouseleave", ({ cell }) => {
            cell.removeTools();
            const ports = document.querySelectorAll(
              `[data-cell-id='${cell.id}'] .x6-port-body`
            );
            this.showPorts(ports, false);
          });
          this.graph.fromJSON(this.dataOption);
          let options = {
            target: this.graph,
            scaled: false,
            animation: true,
          };
          this.dnd = new Addon.Dnd(options);
          this.history = this.graph.history;
          this.history.on("change", () => {
            this.canRedo = this.history.canRedo();
            this.canUndo = this.history.canUndo();
          });
        },
      }).mount("#app");
    </script>
  </body>
</html>
